<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Wide Demo</title>
		<link rel="stylesheet" href="{{.StaticServer}}/static/codemirror-4.4/codemirror.css">
		<link rel="stylesheet" href="{{.StaticServer}}/static/codemirror-4.4/theme/lesser-dark.css">
		
		<script type="text/javascript" src="{{.StaticServer}}/static/codemirror-4.4/codemirror.js"></script>
		<script type="text/javascript" src="{{.StaticServer}}/static/codemirror-4.4/mode/go/go.js"></script>
		<script type="text/javascript" src="{{.StaticServer}}/static/js/lib/jquery-2.1.1.min.js"></script>
	</head>
	
	<body>
		<div>
			<div>
				<div></div>
			</div>
			
			<div >
				<div>			
					<textarea id="code" name="code">
// You can edit this code!
// Click here and start typing.
package main

import (
    "fmt"
	"time"
)

func main() {
	for i := 0; i < 5; i++ {
		fmt.Println("Hello, 世界")
		time.Sleep(time.Second)
	}
}
					</textarea>
				</div>
			</div>	
	
			<div>
				<button id='runBtn' onclick='run()'>Run</button>
				<button id='fmtBtn' onclick='fmt()'>Format</button>
			</div>

			<div>			
				<textarea id='output' rows='10' cols='80'></textarea>
			</div>
			
		</div>
		
		<script type="text/javascript">      
			var editor = CodeMirror.fromTextArea(document.getElementById('code'), {
				mode: 'go',
				lineNumbers: true,
				theme: 'lesser-dark'
		  	});
			
			ws = new WebSocket('ws://localhost:8080/output');
			ws.onopen = function() {
		        console.log('[output onopen] connected');
		    }
		    ws.onmessage = function(e) {
				console.log('[output onmessage]' + e.data);
				
				var data = JSON.parse(e.data);
		        $('#output').val($('#output').val() + data.output);
		    }
		    ws.onclose = function(e) {
		        console.log('[output onclose] disconnected (' + e.code + ')');
		        delete ws;
		    }
		    ws.onerror = function (e) {
		        console.log('[output onerror] ' + e);
		    }
			
			function run() {
				var request = {
					"project": "hello",
					"file": "main.go",
					"code": editor.getValue(),
					"cursor": editor.getCursor()
				};
				
				$.ajax({
					type: 'POST',
					url: '/run',
					data: JSON.stringify(request),
					beforeSend: function(data) {
						$('#output').val('');
					},
					success: function(data) {
						console.log(data);
					},
					dataType: "json"
				});
			}
			
			function fmt() {
				var request = {
					"project": "hello",
					"file": "main.go",
					"code": editor.getValue(),
					"cursor": editor.getCursor()
				};
				
				$.ajax({
					type: 'POST',
					url: '/fmt',
					data: JSON.stringify(request),					
					success: function(data) {
						if (data.succ) {
							editor.setValue(data.code);
						}
					},
					dataType: "json"
				});
			}
		</script>
	</body>

</html>